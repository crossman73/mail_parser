#!/bin/sh
# Pre-commit hook: ìë™ ë¬¸ì„œ ìƒì„±
# Phase 2.4: Git Hook ê¸°ë°˜ ë¬¸ì„œ ìë™í™”

echo "ğŸ”„ Pre-commit: ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘..."

# Python íŒŒì¼ ë³€ê²½ ì—¬ë¶€ í™•ì¸
python_changed=$(git diff --cached --name-only | grep -E '\.(py)$' | wc -l)
template_changed=$(git diff --cached --name-only | grep -E 'templates/.*\.html$' | wc -l)

if [ "$python_changed" -gt 0 ] || [ "$template_changed" -gt 0 ]; then
    echo "ğŸ“ Python/í…œí”Œë¦¿ íŒŒì¼ ë³€ê²½ ê°ì§€ - ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹¤í–‰..."

    # ë¬¸ì„œ ìƒì„± ì‹¤í–‰
    python -c "
try:
    from src.docs import generate_all_documentation
    print('ğŸ” API ìŠ¤ìº” ë° ë¬¸ì„œ ìƒì„± ì¤‘...')
    result = generate_all_documentation()

    if result and 'generated_docs' in result:
        generated_docs = result['generated_docs']
        scan_result = result.get('scan_result', {})
        statistics = scan_result.get('statistics', {})

        print(f'âœ… ë¬¸ì„œ ìƒì„± ì™„ë£Œ: {len(generated_docs)}ê°œ íŒŒì¼')
        print(f'ğŸ” ìŠ¤ìº”ëœ ì—”ë“œí¬ì¸íŠ¸: {statistics.get(\"total_endpoints\", 0)}ê°œ')

        # ìƒì„±ëœ ë¬¸ì„œ íŒŒì¼ë“¤ì„ ìŠ¤í…Œì´ì§•ì— ì¶”ê°€
        import subprocess
        import os

        for doc_type, file_path in generated_docs.items():
            if os.path.exists(file_path):
                subprocess.run(['git', 'add', file_path], check=True)
                print(f'ğŸ“„ ìŠ¤í…Œì´ì§• ì¶”ê°€: {file_path}')

        print('ğŸ“š ë¬¸ì„œ íŒŒì¼ë“¤ì´ ì»¤ë°‹ì— í¬í•¨ë©ë‹ˆë‹¤.')
    else:
        print('âš ï¸ ë¬¸ì„œ ìƒì„±ì— ë¬¸ì œê°€ ìˆì—ˆì§€ë§Œ ì»¤ë°‹ì„ ê³„ì†í•©ë‹ˆë‹¤.')

except Exception as e:
    print(f'âš ï¸ ë¬¸ì„œ ìë™ ìƒì„± ì‹¤íŒ¨: {e}')
    print('ì»¤ë°‹ì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤.')
    import traceback
    traceback.print_exc()
"

    echo "âœ… Pre-commit ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
else
    echo "ğŸ“ Python/í…œí”Œë¦¿ íŒŒì¼ ë³€ê²½ ì—†ìŒ - ë¬¸ì„œ ì—…ë°ì´íŠ¸ ìƒëµ"
fi

exit 0

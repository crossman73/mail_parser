# ğŸ“š ë¬¸ì„œ ìë™ ìƒì„± ë° ë°°í¬
# Phase 2.4: CI/CD íŒŒì´í”„ë¼ì¸

name: ğŸ“š Documentation Auto-Generation

on:
  push:
    branches: [main, master, develop]
    paths:
      - "src/**/*.py"
      - "templates/**/*.html"
      - "config.json"
      - ".github/workflows/docs.yml"

  pull_request:
    branches: [main, master]
    paths:
      - "src/**/*.py"
      - "templates/**/*.html"

  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì§€ì›
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: "ê°•ì œ ë¬¸ì„œ ì¬ìƒì„±"
        required: false
        default: "false"

jobs:
  # 1ë‹¨ê³„: ë¬¸ì„œ ìƒì„± ë° ê²€ì¦
  generate-docs:
    name: ğŸ“„ Generate Documentation
    runs-on: ubuntu-latest

    outputs:
      docs-changed: ${{ steps.check-changes.outputs.docs-changed }}

    steps:
      - name: ğŸ”½ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ë³€ê²½ì‚¬í•­ ë¹„êµë¥¼ ìœ„í•´

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install watchdog  # ìë™ ì—…ë°ì´í„°ìš©

      - name: ğŸ“Š í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸
        run: |
          echo "ğŸ—ï¸ í”„ë¡œì íŠ¸ êµ¬ì¡°:"
          find . -type f -name "*.py" | head -20
          echo "ğŸ“ docs ë””ë ‰í† ë¦¬:"
          ls -la docs/ || echo "docs ë””ë ‰í† ë¦¬ ì—†ìŒ"

      - name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        run: |
          echo "ğŸ” Python êµ¬ë¬¸ ê²€ì‚¬..."
          python -m py_compile src/docs/*.py || echo "âš ï¸ ì¼ë¶€ íŒŒì¼ì— êµ¬ë¬¸ ì˜¤ë¥˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"

          echo "ğŸ“Š ì½”ë“œ í†µê³„:"
          find src/ -name "*.py" -exec wc -l {} + | tail -1

      - name: ğŸ“š ë¬¸ì„œ ìƒì„± ì‹¤í–‰
        run: |
          echo "ğŸ“š API ë¬¸ì„œ ìë™ ìƒì„± ì‹œì‘..."
          python -c "
          try:
              from src.docs import generate_all_documentation
              result = generate_all_documentation()
              if result:
                  print('âœ… ë¬¸ì„œ ìƒì„± ì„±ê³µ')
                  import json
                  print('ğŸ“Š ê²°ê³¼:', json.dumps(result.get('scan_result', {}).get('statistics', {}), indent=2))
              else:
                  print('âŒ ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨')
                  exit(1)
          except Exception as e:
              print(f'âŒ ì˜¤ë¥˜: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          "

      - name: ğŸ“‹ ìƒì„±ëœ ë¬¸ì„œ í™•ì¸
        run: |
          echo "ğŸ“‹ ìƒì„±ëœ ë¬¸ì„œ íŒŒì¼ë“¤:"
          find docs/ -type f -name "*.md" -o -name "*.html" -o -name "*.json" | sort

          echo "ğŸ“Š íŒŒì¼ í¬ê¸°:"
          du -sh docs/* || echo "ë¬¸ì„œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"

      - name: ğŸ” ë¬¸ì„œ í’ˆì§ˆ ê²€ì‚¬
        run: |
          echo "ğŸ” ë¬¸ì„œ í’ˆì§ˆ ê²€ì‚¬..."

          # OpenAPI JSON ìœ íš¨ì„± ê²€ì‚¬
          if [ -f "docs/api/openapi/openapi.json" ]; then
            python -c "import json; json.load(open('docs/api/openapi/openapi.json')); print('âœ… OpenAPI JSON ìœ íš¨')"
          else
            echo "âš ï¸ OpenAPI JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi

          # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ê¸°ë³¸ ê²€ì‚¬
          for md_file in $(find docs/ -name "*.md"); do
            if [ -s "$md_file" ]; then
              echo "âœ… $md_file ($(wc -l < "$md_file") lines)"
            else
              echo "âš ï¸ $md_file (ë¹ˆ íŒŒì¼)"
            fi
          done

      - name: ğŸ”„ ë³€ê²½ì‚¬í•­ í™•ì¸
        id: check-changes
        run: |
          if [ -d "docs" ]; then
            git add docs/
            if git diff --cached --quiet; then
              echo "docs-changed=false" >> $GITHUB_OUTPUT
              echo "ğŸ“ ë¬¸ì„œ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            else
              echo "docs-changed=true" >> $GITHUB_OUTPUT
              echo "ğŸ“ ë¬¸ì„œ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨"
              git diff --cached --name-only | head -10
            fi
          else
            echo "docs-changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ docs ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi

      - name: ğŸ“¤ ë¬¸ì„œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: generated-docs
          path: |
            docs/
            !docs/**/.gitkeep
          retention-days: 30

  # 2ë‹¨ê³„: ë¬¸ì„œ ë°°í¬ (main/master ë¸Œëœì¹˜ë§Œ)
  deploy-docs:
    name: ğŸš€ Deploy Documentation
    runs-on: ubuntu-latest
    needs: generate-docs
    if: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && needs.generate-docs.outputs.docs-changed == 'true' }}

    steps:
      - name: ğŸ”½ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¥ ë¬¸ì„œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: generated-docs
          path: docs/

      - name: ğŸ“ ë¬¸ì„œ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add docs/
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ“š ìë™ ë¬¸ì„œ ì—…ë°ì´íŠ¸ - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "ğŸ“ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi

      - name: ğŸ“Š ë°°í¬ ìš”ì•½
        run: |
          echo "ğŸ‰ ë¬¸ì„œ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“Š ë°°í¬ í†µê³„:"
          find docs/ -type f | wc -l | xargs -I {} echo "  íŒŒì¼ ìˆ˜: {} ê°œ"
          du -sh docs/ | xargs -I {} echo "  ì´ í¬ê¸°: {}"

  # 3ë‹¨ê³„: ë¬¸ì„œ ì›¹ì‚¬ì´íŠ¸ ë°°í¬ (GitHub Pages)
  deploy-pages:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [generate-docs, deploy-docs]
    if: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && needs.generate-docs.outputs.docs-changed == 'true' }}

    # GitHub Pages ë°°í¬ ê¶Œí•œ
    permissions:
      contents: read
      pages: write
      id-token: write

    # ë™ì‹œ ë°°í¬ ë°©ì§€
    concurrency:
      group: "pages"
      cancel-in-progress: false

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ”½ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¥ ë¬¸ì„œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: generated-docs
          path: docs/

      - name: ğŸŒ GitHub Pages ì¤€ë¹„
        run: |
          # index.htmlì´ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "docs/index.html" ]; then
            echo "ğŸ  index.html ìƒì„±..."
            cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ğŸ“š ì´ë©”ì¼ ì¦ê±° ì²˜ë¦¬ ì‹œìŠ¤í…œ ë¬¸ì„œ</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
                  h1 { color: #667eea; }
                  .doc-links { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
                  .doc-card { border: 1px solid #e0e6ed; border-radius: 8px; padding: 20px; }
                  .doc-card h3 { margin-top: 0; color: #2d3748; }
                  .doc-card a { color: #667eea; text-decoration: none; }
                  .doc-card a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <h1>ğŸ“š ì´ë©”ì¼ ì¦ê±° ì²˜ë¦¬ ì‹œìŠ¤í…œ ë¬¸ì„œ</h1>
              <p>ìë™ ìƒì„±ëœ API ë¬¸ì„œ ë° ê°€ì´ë“œì…ë‹ˆë‹¤.</p>

              <div class="doc-links">
                  <div class="doc-card">
                      <h3>ğŸ”Œ API ë¬¸ì„œ</h3>
                      <p><a href="api/references/API_Reference.md">API Reference</a></p>
                      <p><a href="api/references/api_docs.html">HTML API ë¬¸ì„œ</a></p>
                      <p><a href="api/openapi/openapi.json">OpenAPI ëª…ì„¸</a></p>
                  </div>

                  <div class="doc-card">
                      <h3>ğŸ“– ê°œë°œì ê°€ì´ë“œ</h3>
                      <p><a href="guides/developer/Developer_Guide.md">ê°œë°œì ê°€ì´ë“œ</a></p>
                      <p><a href="guides/developer/architecture_refactoring.md">ì•„í‚¤í…ì²˜ ë¬¸ì„œ</a></p>
                  </div>

                  <div class="doc-card">
                      <h3>âš™ï¸ ê´€ë¦¬ì ë¬¸ì„œ</h3>
                      <p><a href="guides/admin/config_guide.md">ì„¤ì • ê°€ì´ë“œ</a></p>
                  </div>
              </div>

              <footer style="margin-top: 50px; color: #718096; font-size: 14px;">
                  <p>ìë™ ìƒì„±: Phase 2.4 CI/CD íŒŒì´í”„ë¼ì¸</p>
              </footer>
          </body>
          </html>
          EOF
          fi

      - name: âš™ï¸ Pages ì„¤ì •
        uses: actions/configure-pages@v3

      - name: ğŸ“¤ Pages ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v2
        with:
          path: "docs"

      - name: ğŸš€ GitHub Pages ë°°í¬
        id: deployment
        uses: actions/deploy-pages@v2

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>통합 타임라인 - {{ app_name }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .timeline {
        position: relative;
        padding-left: 3rem;
      }
      .timeline::before {
        content: "";
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #007bff, #6f42c1);
      }
      .timeline-item {
        position: relative;
        margin-bottom: 2rem;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        left: -2.5rem;
        top: 0.5rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 0 3px #007bff;
      }
      .timeline-item.email::before {
        background: #007bff;
      }
      .timeline-item.evidence::before {
        background: #28a745;
      }
      .timeline-item.high-importance::before {
        box-shadow: 0 0 0 3px #dc3545;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.7);
        }
        50% {
          box-shadow: 0 0 0 6px rgba(220, 53, 69, 0.4);
        }
        100% {
          box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.7);
        }
      }
      .timeline-content {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .timeline-content:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }
      .timeline-date {
        position: absolute;
        left: -6rem;
        top: 0;
        width: 4rem;
        text-align: center;
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: bold;
      }
      .importance-badge {
        position: absolute;
        top: -0.5rem;
        right: -0.5rem;
        font-size: 0.7rem;
      }
      .attachment-list {
        max-height: 200px;
        overflow-y: auto;
      }
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .period-info {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('index') }}">
          <i class="bi bi-clock-history me-2"></i>통합 타임라인
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="{{ url_for('additional_evidence') }}">
            <i class="bi bi-folder-plus me-1"></i>추가 증거
          </a>
          <a class="nav-link" href="{{ url_for('verify_integrity') }}">
            <i class="bi bi-shield-check me-1"></i>무결성 검증
          </a>
          <a class="nav-link" href="{{ url_for('index') }}">
            <i class="bi bi-house me-1"></i>메인
          </a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- 플래시 메시지 -->
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %} {% if timeline_result %}
      <!-- 통계 정보 -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="card stats-card">
            <div class="card-body">
              <h4 class="card-title text-white mb-3">
                <i class="bi bi-graph-up me-2"></i>통합 타임라인 현황
              </h4>
              <div class="row text-center">
                <div class="col-3">
                  <div class="display-6 text-white fw-bold">
                    {{ timeline_result.total_items }}
                  </div>
                  <small class="text-white-50">총 항목</small>
                </div>
                <div class="col-3">
                  <div class="display-6 text-white fw-bold">
                    {{ timeline_result.email_items }}
                  </div>
                  <small class="text-white-50">이메일</small>
                </div>
                <div class="col-3">
                  <div class="display-6 text-white fw-bold">
                    {{ timeline_result.additional_items }}
                  </div>
                  <small class="text-white-50">추가증거</small>
                </div>
                <div class="col-3">
                  <div class="display-6 text-white fw-bold">
                    {{
                    timeline_result.timeline_report.statistics.high_importance
                    }}
                  </div>
                  <small class="text-white-50">중요 항목</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card period-info">
            <div class="card-body text-center">
              <h5 class="card-title text-white">
                <i class="bi bi-calendar-range me-2"></i>증거 기간
              </h5>
              <div class="text-white">
                <div class="fw-bold">
                  {{ timeline_result.timeline_report.period.start_date }}
                </div>
                <small>~</small>
                <div class="fw-bold">
                  {{ timeline_result.timeline_report.period.end_date }}
                </div>
                <small class="text-white-50 mt-2 d-block">
                  총 {{ timeline_result.timeline_report.period.duration_days
                  }}일간
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 액션 버튼 -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="card-title mb-1">
                <i class="bi bi-download me-2"></i>법원 제출용 자료 다운로드
              </h5>
              <p class="text-muted mb-0">
                시간순으로 정렬된 모든 증거와 실제 파일들
              </p>
            </div>
            <div class="col-md-4">
              <div class="d-grid gap-2">
                <a
                  href="{{ url_for('generate_timeline_package') }}"
                  class="btn btn-success"
                >
                  <i class="bi bi-box-arrow-up me-1"></i>완전 패키지 다운로드
                </a>
                <a
                  href="{{ url_for('download_timeline_excel') }}"
                  class="btn btn-outline-primary"
                >
                  <i class="bi bi-file-earmark-excel me-1"></i>Excel 타임라인
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 타임라인 -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-list-timeline me-2"></i>시간순 통합 타임라인
            <small class="text-muted"
              >({{ timeline_result.timeline_report.summary }})</small
            >
          </h5>
        </div>
        <div class="card-body">
          {% if timeline_result.timeline_items %}
          <div class="timeline">
            {% for item in timeline_result.timeline_items %}
            <div
              class="timeline-item {{ 'email' if item.type == 'EMAIL' else 'evidence' }} {{ 'high-importance' if item.importance == 'HIGH' else '' }}"
            >
              <div class="timeline-date">
                {{ item.event_date.strftime('%m/%d') if item.event_date.strftime
                else item.event_date }}
                <br />
                <small>{{ item.event_time }}</small>
              </div>

              <div class="timeline-content">
                <!-- 중요도 배지 -->
                {% if item.importance == 'HIGH' %}
                <span class="badge bg-danger importance-badge">중요</span>
                {% elif item.importance == 'MEDIUM' %}
                <span class="badge bg-warning importance-badge">보통</span>
                {% else %}
                <span class="badge bg-secondary importance-badge">낮음</span>
                {% endif %}

                <div class="d-flex align-items-start">
                  <div class="me-3">
                    {% if item.type == 'EMAIL' %}
                    <i class="bi bi-envelope-fill fs-2 text-primary"></i>
                    {% else %}
                    <i class="bi bi-file-earmark-plus fs-2 text-success"></i>
                    {% endif %}
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1">
                      {% if item.type == 'EMAIL' %}
                      <span class="badge bg-primary me-2">이메일</span>
                      {% else %}
                      <span class="badge bg-success me-2"
                        >{{ item.category }}</span
                      >
                      {% if item.evidence_number %}
                      <span class="badge bg-info me-2"
                        >{{ item.evidence_number }}</span
                      >
                      {% endif %} {% endif %} {{ item.title }}
                    </h6>

                    {% if item.type == 'EMAIL' %}
                    <div class="small text-muted mb-2">
                      <strong>발신:</strong> {{ item.participants.from }}<br />
                      <strong>수신:</strong> {{ item.participants.to }} {% if
                      item.participants.cc %} <br /><strong>참조:</strong> {{
                      item.participants.cc }} {% endif %}
                    </div>
                    {% endif %} {% if item.description %}
                    <p class="text-muted small mb-2">{{ item.description }}</p>
                    {% endif %}

                    <!-- 첨부파일 및 증거파일 -->
                    {% if item.type == 'EMAIL' %} {% if item.attachments %}
                    <div class="mt-2">
                      <h6 class="small">
                        <i class="bi bi-paperclip me-1"></i>첨부파일 ({{
                        item.attachments | length }}개)
                      </h6>
                      <div class="attachment-list">
                        {% for attachment in item.attachments %}
                        <div class="small text-muted">
                          <i class="bi bi-file me-1"></i>{{ attachment.name }}
                          <span class="text-info"
                            >({{ "%.1f" | format(attachment.size / 1024) }}
                            KB)</span
                          >
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                    {% endif %} {% if item.evidence_files %}
                    <div class="mt-2">
                      <h6 class="small">
                        <i class="bi bi-shield-check me-1"></i>증거파일 ({{
                        item.evidence_files | length }}개)
                      </h6>
                      {% for evidence in item.evidence_files %}
                      <span class="badge bg-outline-primary me-1"
                        >{{ evidence.type }}</span
                      >
                      {% endfor %}
                    </div>
                    {% endif %} {% else %}
                    <!-- 추가 증거 정보 -->
                    <div class="mt-2">
                      <div class="small">
                        <i class="bi bi-file-binary me-1"></i>
                        {{ item.file_info.name }}
                        <span class="text-info"
                          >({{ "%.1f" | format(item.file_info.size / 1024) }}
                          KB)</span
                        >
                      </div>
                      {% if item.related_emails %}
                      <div class="small text-muted mt-1">
                        <i class="bi bi-link me-1"></i>관련 이메일: {{
                        item.related_emails | length }}건
                      </div>
                      {% endif %}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-5">
            <i
              class="bi bi-clock-history text-muted"
              style="font-size: 4rem"
            ></i>
            <h4 class="mt-3 text-muted">타임라인 항목이 없습니다</h4>
            <p class="text-muted">
              이메일을 처리하거나 추가 증거를 등록한 후 다시 시도하세요.
            </p>
          </div>
          {% endif %}
        </div>
      </div>

      {% else %}
      <!-- 타임라인 생성 필요 -->
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-clock-history text-muted" style="font-size: 4rem"></i>
          <h3 class="mt-3">통합 타임라인 생성</h3>
          <p class="text-muted mb-4">
            이메일과 추가 증거를 시간순으로 통합하여<br />
            법원 제출용 타임라인을 생성합니다.
          </p>
          <button class="btn btn-primary btn-lg" onclick="location.reload()">
            <i class="bi bi-clock-history me-2"></i>타임라인 생성하기
          </button>
        </div>
      </div>
      {% endif %}

      <!-- 도움말 -->
      <div class="card mt-4">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>통합 타임라인 특징
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <h6><i class="bi bi-clock text-primary me-1"></i>시간순 정렬</h6>
              <p class="small">
                이메일 발송일시와 추가 증거 발생일자를 기준으로 시간순 정렬
              </p>
            </div>
            <div class="col-md-4">
              <h6>
                <i class="bi bi-files text-success me-1"></i>실제 파일 포함
              </h6>
              <p class="small">
                법원 제출용 패키지에는 모든 증거의 실제 파일이 포함됨
              </p>
            </div>
            <div class="col-md-4">
              <h6>
                <i class="bi bi-shield-check text-warning me-1"></i>무결성 보장
              </h6>
              <p class="small">
                각 파일의 SHA-256 해시값으로 무결성 검증 및 보장
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 타임라인 아이템 클릭 시 확장/축소
      document.querySelectorAll(".timeline-content").forEach((item) => {
        item.addEventListener("click", function () {
          const attachmentList = this.querySelector(".attachment-list");
          if (attachmentList) {
            attachmentList.style.maxHeight =
              attachmentList.style.maxHeight === "none" ? "200px" : "none";
          }
        });
      });

      // 스크롤 시 타임라인 애니메이션
      function animateTimeline() {
        const timelineItems = document.querySelectorAll(".timeline-item");
        const windowHeight = window.innerHeight;

        timelineItems.forEach((item) => {
          const itemTop = item.getBoundingClientRect().top;
          if (itemTop < windowHeight * 0.8) {
            item.style.opacity = "1";
            item.style.transform = "translateX(0)";
          }
        });
      }

      // 초기 스타일 설정
      document.querySelectorAll(".timeline-item").forEach((item) => {
        item.style.opacity = "0";
        item.style.transform = "translateX(-20px)";
        item.style.transition = "all 0.6s ease";
      });

      window.addEventListener("scroll", animateTimeline);
      window.addEventListener("load", animateTimeline);
    </script>
  </body>
</html>

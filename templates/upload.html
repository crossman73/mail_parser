{% extends "base.html" %} {% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h4 class="mb-0">
          <i class="fas fa-upload me-2"></i>
          mbox 파일 업로드
        </h4>
      </div>
      <div class="card-body">
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <strong>mbox 파일이란?</strong><br />
          이메일 클라이언트(Outlook, Thunderbird 등)에서 내보낸 메일박스
          파일입니다. 이 파일을 업로드하면 자동으로 파싱하여 법정 증거 문서를
          생성합니다.
        </div>

        <form
          action="/upload"
          method="post"
          enctype="multipart/form-data"
          id="uploadForm"
        >
          <div class="mb-3">
            <label for="mbox_file" class="form-label">
              <i class="fas fa-file me-1"></i>
              mbox 파일 선택
            </label>
            <input
              type="file"
              class="form-control"
              id="mbox_file"
              name="mbox_file"
              accept=".mbox,.mbx,.eml"
              required
            />
            <div class="form-text">
              지원 파일 형식: .mbox, .mbx, .eml (최대 1GB)
            </div>
          </div>

          <div class="mb-3">
            <label for="evidence_prefix" class="form-label">
              <i class="fas fa-gavel me-1"></i>
              증거 번호 접두사 (선택사항)
            </label>
            <select
              class="form-select"
              id="evidence_prefix"
              name="evidence_prefix"
            >
              <option value="갑">갑 제○호증</option>
              <option value="을">을 제○호증</option>
              <option value="병">병 제○호증</option>
              <option value="정">정 제○호증</option>
            </select>
            <div class="form-text">
              생성될 증거 문서의 번호 체계를 선택하세요.
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                value="true"
                id="generate_timeline"
                name="generate_timeline"
                checked
              />
              <label class="form-check-label" for="generate_timeline">
                <i class="fas fa-timeline me-1"></i>
                타임라인 자동 생성
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                value="true"
                id="extract_attachments"
                name="extract_attachments"
                checked
              />
              <label class="form-check-label" for="extract_attachments">
                <i class="fas fa-paperclip me-1"></i>
                첨부파일 자동 추출
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                value="true"
                id="verify_integrity"
                name="verify_integrity"
                checked
              />
              <label class="form-check-label" for="verify_integrity">
                <i class="fas fa-shield-alt me-1"></i>
                무결성 검증 수행
              </label>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
              <i class="fas fa-upload me-2"></i>
              파일 업로드 및 처리 시작
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i>
              메인 페이지로 돌아가기
            </a>
          </div>
        </form>

        <!-- 진행률 표시 (숨김 상태) -->
        <div id="progressContainer" class="mt-4" style="display: none">
          <h5>
            <i class="fas fa-cog fa-spin me-2"></i>
            처리 중...
          </h5>
          <div class="progress mb-3">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: 0%"
              id="progressBar"
            >
              0%
            </div>
          </div>
          <div id="statusText" class="text-muted">파일 업로드 준비 중...</div>
        </div>
      </div>
    </div>

    <!-- 도움말 카드 -->
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-question-circle me-2"></i>
          사용 가이드
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6>
              <i class="fas fa-file-export text-primary me-2"></i>mbox 파일
              내보내기
            </h6>
            <ul class="list-unstyled">
              <li>
                <strong>Outlook:</strong> 파일 → 열기 및 내보내기 →
                가져오기/내보내기
              </li>
              <li><strong>Thunderbird:</strong> 도구 → 가져오기</li>
              <li><strong>Gmail:</strong> Google Takeout 사용</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-cogs text-success me-2"></i>처리 과정</h6>
            <ul class="list-unstyled">
              <li>1. 이메일 파싱 및 분석</li>
              <li>2. 증거 문서 자동 생성</li>
              <li>3. 첨부파일 추출</li>
              <li>4. 무결성 해시 생성</li>
              <li>5. 타임라인 시각화</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 관리자 링크 섹션 -->
  <div class="container mt-4">
    <div class="row">
      <div class="col-12 text-center">
        <a href="/admin" class="btn btn-warning">
          <i class="fas fa-cog me-1"></i>시스템 관리
        </a>
        <a href="/" class="btn btn-secondary ms-2">
          <i class="fas fa-home me-1"></i>홈으로
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script type="module">
  import { submitFormAsync } from "/static/js/common.js";

  const form = document.getElementById("uploadForm");
  const uploadBtn = document.getElementById("uploadBtn");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const statusText = document.getElementById("statusText");

  // Keep drag/drop behavior from previous implementation
  const card = document.querySelector(".card-body");
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  ["dragenter", "dragover", "dragleave", "drop"].forEach((ev) =>
    card.addEventListener(ev, preventDefaults, false)
  );
  ["dragenter", "dragover"].forEach((ev) =>
    card.addEventListener(ev, () => card.classList.add("bg-light"), false)
  );
  ["dragleave", "drop"].forEach((ev) =>
    card.addEventListener(ev, () => card.classList.remove("bg-light"), false)
  );
  card.addEventListener("drop", (e) => {
    const dt = e.dataTransfer;
    if (dt.files.length) {
      document.getElementById("mbox_file").files = dt.files;
    }
  });

  form.addEventListener("submit", async (e) => {
    // If JS disabled, the browser will perform a regular form POST as fallback.
    e.preventDefault();

    // basic validations
    const fileInput = document.getElementById("mbox_file");
    if (!fileInput.files.length) {
      alert("파일을 선택해주세요.");
      return;
    }
    const maxSize = 1024 * 1024 * 1024;
    if (fileInput.files[0].size > maxSize) {
      alert("파일 크기가 1GB를 초과합니다.");
      return;
    }

    // UI
    uploadBtn.disabled = true;
    uploadBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin me-2"></i>업로드 중...';
    progressContainer.style.display = "block";

    try {
      const xhr = await submitFormAsync(form, {
        onProgress: (p) => {
          progressBar.style.width = p + "%";
          progressBar.textContent = p + "%";
          statusText.textContent =
            p < 50
              ? "파일 업로드 중..."
              : p < 100
              ? "업로드 완료, 서버에서 처리 중..."
              : "완료";
        },
      });
      // 성공 처리: 서버가 리다이렉트했다면 responseURL로 이동
      if (xhr && xhr.status >= 200 && xhr.status < 400) {
        if (xhr.responseURL) {
          window.location.href = xhr.responseURL;
        } else {
          window.location.href = "/";
        }
      } else {
        throw new Error("업로드 실패");
      }
    } catch (err) {
      alert("업로드 중 오류가 발생했습니다: " + (err.message || err));
      uploadBtn.disabled = false;
      uploadBtn.innerHTML =
        '<i class="fas fa-upload me-2"></i>파일 업로드 및 처리 시작';
      progressContainer.style.display = "none";
    }
  });

  // ensure upload button text resets if user reloads
  window.addEventListener("beforeunload", () => {
    uploadBtn.disabled = true;
  });
</script>
{% endblock %}

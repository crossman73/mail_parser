{% extends "base.html" %} {% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h4 class="mb-0">
          <i class="fas fa-upload me-2"></i>
          mbox 파일 업로드
        </h4>
      </div>
      <div class="card-body">
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          <strong>mbox 파일이란?</strong><br />
          이메일 클라이언트(Outlook, Thunderbird 등)에서 내보낸 메일박스
          파일입니다. 이 파일을 업로드하면 자동으로 파싱하여 법정 증거 문서를
          생성합니다.
        </div>

        <form
          action="/upload"
          method="post"
          enctype="multipart/form-data"
          id="uploadForm"
        >
          <div class="mb-3">
            <label for="mbox_file" class="form-label">
              <i class="fas fa-file me-1"></i>
              mbox 파일 선택
            </label>
            <input
              type="file"
              class="form-control"
              id="mbox_file"
              name="mbox_file"
              accept=".mbox,.mbx,.eml"
              required
            />
            <div class="form-text">
              지원 파일 형식: .mbox, .mbx, .eml (최대 1GB)
            </div>
          </div>

          <div class="mb-3">
            <label for="evidence_prefix" class="form-label">
              <i class="fas fa-gavel me-1"></i>
              증거 번호 접두사 (선택사항)
            </label>
            <select
              class="form-select"
              id="evidence_prefix"
              name="evidence_prefix"
            >
              <option value="갑">갑 제○호증</option>
              <option value="을">을 제○호증</option>
              <option value="병">병 제○호증</option>
              <option value="정">정 제○호증</option>
            </select>
            <div class="form-text">
              생성될 증거 문서의 번호 체계를 선택하세요.
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                value="true"
                id="generate_timeline"
                name="generate_timeline"
                checked
              />
              <label class="form-check-label" for="generate_timeline">
                <i class="fas fa-timeline me-1"></i>
                타임라인 자동 생성
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                value="true"
                id="extract_attachments"
                name="extract_attachments"
                checked
              />
              <label class="form-check-label" for="extract_attachments">
                <i class="fas fa-paperclip me-1"></i>
                첨부파일 자동 추출
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                value="true"
                id="verify_integrity"
                name="verify_integrity"
                checked
              />
              <label class="form-check-label" for="verify_integrity">
                <i class="fas fa-shield-alt me-1"></i>
                무결성 검증 수행
              </label>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
              <i class="fas fa-upload me-2"></i>
              파일 업로드 및 처리 시작
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i>
              메인 페이지로 돌아가기
            </a>
          </div>
        </form>

        <!-- 진행률 표시 (숨김 상태) -->
        <div id="progressContainer" class="mt-4" style="display: none">
          <h5>
            <i class="fas fa-cog fa-spin me-2"></i>
            처리 중...
          </h5>
          <div class="progress mb-3">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: 0%"
              id="progressBar"
            >
              0%
            </div>
          </div>
          <div id="statusText" class="text-muted">파일 업로드 준비 중...</div>
        </div>
      </div>
    </div>

    <!-- 도움말 카드 -->
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-question-circle me-2"></i>
          사용 가이드
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6>
              <i class="fas fa-file-export text-primary me-2"></i>mbox 파일
              내보내기
            </h6>
            <ul class="list-unstyled">
              <li>
                <strong>Outlook:</strong> 파일 → 열기 및 내보내기 →
                가져오기/내보내기
              </li>
              <li><strong>Thunderbird:</strong> 도구 → 가져오기</li>
              <li><strong>Gmail:</strong> Google Takeout 사용</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6><i class="fas fa-cogs text-success me-2"></i>처리 과정</h6>
            <ul class="list-unstyled">
              <li>1. 이메일 파싱 및 분석</li>
              <li>2. 증거 문서 자동 생성</li>
              <li>3. 첨부파일 추출</li>
              <li>4. 무결성 해시 생성</li>
              <li>5. 타임라인 시각화</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 관리자 링크 섹션 -->
  <div class="container mt-4">
    <div class="row">
      <div class="col-12 text-center">
        <a href="/admin" class="btn btn-warning">
          <i class="fas fa-cog me-1"></i>시스템 관리
        </a>
        <a href="/" class="btn btn-secondary ms-2">
          <i class="fas fa-home me-1"></i>홈으로
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let uploadInProgress = false;

  document
    .getElementById("uploadForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      if (uploadInProgress) {
        return;
      }

      const fileInput = document.getElementById("mbox_file");
      const uploadBtn = document.getElementById("uploadBtn");
      const progressContainer = document.getElementById("progressContainer");

      if (!fileInput.files.length) {
        alert("파일을 선택해주세요.");
        return;
      }

      // 파일 크기 확인 (1GB)
      const maxSize = 1024 * 1024 * 1024;
      if (fileInput.files[0].size > maxSize) {
        alert("파일 크기가 1GB를 초과합니다.");
        return;
      }

      uploadFileWithProgress();
    });

  function uploadFileWithProgress() {
    const formData = new FormData();
    const fileInput = document.getElementById("mbox_file");
    const uploadBtn = document.getElementById("uploadBtn");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const statusText = document.getElementById("statusText");

    uploadInProgress = true;

    // 폼 데이터 준비
    formData.append("mbox_file", fileInput.files[0]);
    formData.append(
      "evidence_prefix",
      document.getElementById("evidence_prefix").value
    );
    formData.append(
      "generate_timeline",
      document.getElementById("generate_timeline").checked
    );
    formData.append(
      "extract_attachments",
      document.getElementById("extract_attachments").checked
    );
    formData.append(
      "verify_integrity",
      document.getElementById("verify_integrity").checked
    );

    // UI 업데이트
    uploadBtn.disabled = true;
    uploadBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin me-2"></i>업로드 중...';
    progressContainer.style.display = "block";

    // XMLHttpRequest로 업로드
    const xhr = new XMLHttpRequest();

    // 업로드 진행률
    xhr.upload.addEventListener("progress", function (e) {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + "%";
        progressBar.textContent = Math.round(percentComplete) + "%";

        if (percentComplete < 50) {
          statusText.textContent = "파일 업로드 중...";
        } else if (percentComplete < 100) {
          statusText.textContent = "업로드 완료, 서버에서 처리 중...";
        }
      }
    });

    // 업로드 완료
    xhr.addEventListener("load", function () {
      if (xhr.status === 200 || xhr.status === 302) {
        progressBar.style.width = "100%";
        progressBar.textContent = "100%";
        statusText.textContent = "처리 페이지로 이동 중...";

        // 응답이 리다이렉트인 경우 URL 추출해서 이동
        if (xhr.responseURL) {
          window.location.href = xhr.responseURL;
        } else {
          // 폴백: 파싱된 응답에서 리다이렉트 URL 찾기
          setTimeout(() => {
            window.location.href = "/";
          }, 1000);
        }
      } else {
        handleUploadError("서버 오류가 발생했습니다.");
      }
    });

    // 업로드 오류
    xhr.addEventListener("error", function () {
      handleUploadError("업로드 중 네트워크 오류가 발생했습니다.");
    });

    // 업로드 시작
    xhr.open("POST", "/upload", true);
    xhr.send(formData);
  }

  function handleUploadError(message) {
    uploadInProgress = false;
    const uploadBtn = document.getElementById("uploadBtn");
    const progressContainer = document.getElementById("progressContainer");

    alert(message);
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>파일 업로드';
    progressContainer.style.display = "none";
  }

  // 드래그 앤 드롭 기능
  const fileInput = document.getElementById("mbox_file");
  const card = document.querySelector(".card-body");

  ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
    card.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ["dragenter", "dragover"].forEach((eventName) => {
    card.addEventListener(eventName, highlight, false);
  });

  ["dragleave", "drop"].forEach((eventName) => {
    card.addEventListener(eventName, unhighlight, false);
  });

  function highlight(e) {
    card.classList.add("bg-light");
  }

  function unhighlight(e) {
    card.classList.remove("bg-light");
  }

  card.addEventListener("drop", handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files.length > 0) {
      fileInput.files = files;
      // 파일명 표시 업데이트
      const fileName = files[0].name;
      const fileSize = (files[0].size / (1024 * 1024)).toFixed(2);
      console.log(`파일 선택됨: ${fileName} (${fileSize}MB)`);
    }
  }
</script>
{% endblock %}

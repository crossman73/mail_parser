{% extends "base.html" %} {% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h4 class="mb-0">
          <i class="fas fa-cog fa-spin me-2"></i>
          íŒŒì¼ ì²˜ë¦¬ ì¤‘
        </h4>
      </div>
      <div class="card-body">
        <div class="mb-4">
          <h5 id="taskName">
            {{ progress.task_name if progress else 'ì²˜ë¦¬ ì¤‘...' }}
          </h5>
          <div class="progress mb-3" style="height: 25px">
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="width: {{ progress.progress if progress else 0 }}%"
              id="progressBar"
            >
              <span id="progressText"
                >{{ progress.progress|round(1) if progress else 0 }}%</span
              >
            </div>
          </div>
          <div id="statusMessage" class="text-muted">
            {{ progress.current_message if progress else 'ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...'
            }}
          </div>
        </div>

        <!-- ìƒíƒœë³„ UI -->
        <div
          id="processingStatus"
          style="display: {{ 'block' if progress and progress.status == 'processing' else 'none' }}"
        >
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...
          </div>
        </div>

        <div
          id="completedStatus"
          style="display: {{ 'block' if progress and progress.status == 'completed' else 'none' }}"
        >
          <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš©ì´ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>

        <div
          id="errorStatus"
          style="display: {{ 'block' if progress and progress.status == 'error' else 'none' }}"
        >
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
          </div>
          <div class="alert alert-warning">
            <strong>ì˜¤ë¥˜ ë‚´ìš©:</strong>
            <span id="errorMessage"
              >{{ progress.error if progress and progress.error else 'ì•Œ ìˆ˜ ì—†ëŠ”
              ì˜¤ë¥˜' }}</span
            >
          </div>
          <div class="d-grid gap-2">
            <a href="/upload" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-2"></i>
              ë‹¤ì‹œ ì—…ë¡œë“œí•˜ê¸°
            </a>
            <a href="/" class="btn btn-outline-secondary">
              <i class="fas fa-home me-2"></i>
              ë©”ì¸ í˜ì´ì§€ë¡œ
            </a>
          </div>
        </div>

        <!-- ì²˜ë¦¬ ì •ë³´ -->
        <div class="mt-4">
          <h6 class="text-muted">ì²˜ë¦¬ ì •ë³´</h6>
          <div class="row">
            <div class="col-sm-6">
              <small class="text-muted">
                <strong>ì‹œì‘ ì‹œê°„:</strong><br />
                <span id="startedTime"
                  >{{ progress.started_at if progress else '' }}</span
                >
              </small>
            </div>
            <div class="col-sm-6">
              <small class="text-muted">
                <strong>ìµœì¢… ì—…ë°ì´íŠ¸:</strong><br />
                <span id="updatedTime"
                  >{{ progress.updated_at if progress else '' }}</span
                >
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë„ì›€ë§ -->
    <div class="card mt-4">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-lightbulb me-2"></i>
          ì²˜ë¦¬ ê³¼ì • ì•ˆë‚´
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary">ì²˜ë¦¬ ë‹¨ê³„</h6>
            <ol class="list-unstyled">
              <li>1ï¸âƒ£ íŒŒì¼ ê²€ì¦</li>
              <li>2ï¸âƒ£ ì²˜ë¦¬ê¸° ì´ˆê¸°í™”</li>
              <li>3ï¸âƒ£ ì´ë©”ì¼ íŒŒì¼ ë¡œë“œ</li>
              <li>4ï¸âƒ£ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ</li>
              <li>5ï¸âƒ£ ë°ì´í„° ì €ì¥</li>
            </ol>
          </div>
          <div class="col-md-6">
            <h6 class="text-success">ì™„ë£Œ í›„ ê¸°ëŠ¥</h6>
            <ul class="list-unstyled">
              <li>ğŸ“§ ì´ë©”ì¼ ëª©ë¡ ì¡°íšŒ</li>
              <li>ğŸ“Š íƒ€ì„ë¼ì¸ ë¶„ì„</li>
              <li>âš–ï¸ ë²•ì • ì¦ê±° ìƒì„±</li>
              <li>ğŸ”’ ë¬´ê²°ì„± ê²€ì¦</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ë§í¬ ì„¹ì…˜ -->
  <div class="container mt-4">
    <div class="row">
      <div class="col-12 text-center">
        <a href="/admin" class="btn btn-warning">
          <i class="fas fa-cog me-1"></i>ì‹œìŠ¤í…œ ê´€ë¦¬
        </a>
        <a href="/" class="btn btn-secondary ms-2">
          <i class="fas fa-home me-1"></i>í™ˆìœ¼ë¡œ
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const taskId = "{{ task_id }}";
  let pollInterval;

  function updateProgress() {
    fetch(`/api/progress/${taskId}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          console.error("Progress fetch error:", data.error);
          return;
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
        const statusMessage = document.getElementById("statusMessage");
        const taskName = document.getElementById("taskName");
        const updatedTime = document.getElementById("updatedTime");

        progressBar.style.width = `${data.progress}%`;
        progressText.textContent = `${Math.round(data.progress)}%`;
        statusMessage.textContent = data.current_message;
        taskName.textContent = data.task_name;

        // ì‹œê°„ í¬ë§·íŒ…
        if (data.updated_at) {
          const updateTime = new Date(data.updated_at).toLocaleString("ko-KR");
          updatedTime.textContent = updateTime;
        }

        // ìƒíƒœë³„ UI ì—…ë°ì´íŠ¸
        const processingStatus = document.getElementById("processingStatus");
        const completedStatus = document.getElementById("completedStatus");
        const errorStatus = document.getElementById("errorStatus");

        // ëª¨ë“  ìƒíƒœ ìˆ¨ê¸°ê¸°
        processingStatus.style.display = "none";
        completedStatus.style.display = "none";
        errorStatus.style.display = "none";

        if (data.status === "processing") {
          processingStatus.style.display = "block";
        } else if (data.status === "completed") {
          completedStatus.style.display = "block";
          // ì™„ë£Œ ì‹œ í´ë§ ì¤‘ì§€
          if (pollInterval) {
            clearInterval(pollInterval);
          }
          // ì§„í–‰ë¥ ì„ 100%ë¡œ ì„¤ì •
          progressBar.style.width = "100%";
          progressText.textContent = "100%";

          // ì™„ë£Œ ì‹œ ì´ë©”ì¼ ëª©ë¡ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ ì¶”ê°€
          const completedDiv = document.getElementById("completedStatus");
          completedDiv.innerHTML = `
            <div class="alert alert-success">
              <h5><i class="fas fa-check-circle me-2"></i>íŒŒì‹±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h5>
              <p class="mb-3">ì´ë©”ì¼ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ íŒŒì‹±ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì¦ê±° ìƒì„±ì„ ìœ„í•´ ì´ë©”ì¼ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              <div class="d-grid gap-2 d-md-block">
                <a href="/emails/${taskId}" class="btn btn-primary">
                  <i class="fas fa-list me-1"></i>ì´ë©”ì¼ ëª©ë¡ ë³´ê¸° ë° ì¦ê±° ìƒì„±
                </a>
                <a href="/" class="btn btn-outline-secondary ms-2">
                  <i class="fas fa-home me-1"></i>í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </a>
              </div>
            </div>
          `;

          // ìë™ ì´ë™ ì œê±° - ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí•˜ë„ë¡ í•¨
          // setTimeout(() => {
          //   window.location.href = `/emails/${taskId}`;
          // }, 3000);
        } else if (data.status === "error") {
          errorStatus.style.display = "block";
          document.getElementById("errorMessage").textContent =
            data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
          // ì˜¤ë¥˜ ì‹œ í´ë§ ì¤‘ì§€
          if (pollInterval) {
            clearInterval(pollInterval);
          }
        }
      })
      .catch((error) => {
        console.error("Progress polling error:", error);
      });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ í´ë§ ì‹œì‘
  document.addEventListener("DOMContentLoaded", function () {
    // ì¦‰ì‹œ í•œ ë²ˆ ì—…ë°ì´íŠ¸
    updateProgress();

    // 1ì´ˆë§ˆë‹¤ í´ë§
    pollInterval = setInterval(updateProgress, 1000);
  });

  // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ í´ë§ ì¤‘ì§€
  window.addEventListener("beforeunload", function () {
    if (pollInterval) {
      clearInterval(pollInterval);
    }
  });
</script>
{% endblock %}
